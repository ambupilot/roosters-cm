let roosters=[],comments={},locoflexComments={},isEditable=!1;async function fetchAllWeeks(){try{const e=await fetch("get_roosters.php"),t=await e.json();roosters=t,populateWeekSelect();const a=51;populateTable(a),updateWeekInfo(a)}catch(e){console.error("Fout bij ophalen van gegevens:",e),showFeedback("Fout bij ophalen van gegevens","error")}}async function fetchWeekData(e){try{const t=await fetch(`get_roosters.php?week=${e}`),a=await t.json();roosters=a,populateTable(e),updateWeekInfo(e)}catch(e){console.error("Fout bij ophalen van weekgegevens:",e),showFeedback("Fout bij ophalen van weekgegevens","error")}}function updateWeekInfo(e){const t=(new Date).getFullYear(),a=dayjs().year(t).isoWeek(e).startOf("isoWeek"),n=dayjs().year(t).isoWeek(e).endOf("isoWeek");document.getElementById("current-week").textContent=`Kalenderweek: ${e}`,document.getElementById("week-dates").textContent=`${a.format("DD MMMM YYYY")} tot en met ${n.format("DD MMMM YYYY")}`}function populateWeekSelect(){const e=[...new Set(roosters.map((e=>e.startKalenderWeek)))],t=document.getElementById("week-select");t.innerHTML=e.map((e=>`<option value="${e}">Week ${e}</option>`)).join(""),t.addEventListener("change",(e=>{fetchWeekData(parseInt(e.target.value))}))}function populateTable(e){const t=document.getElementById("rooster-body");t.innerHTML="",roosters.filter((t=>Number(t.startKalenderWeek)===e)).forEach((a=>{const n=`${a.startKalenderWeek}-${a.dagVanDeWeek}`;comments[n]=void 0!==comments[n]?comments[n]:a.opmerkingen||"",locoflexComments[n]=void 0!==locoflexComments[n]?locoflexComments[n]:a.locoflex||"";const o=(new Date).getFullYear(),s=dayjs().year(o).isoWeek(e).startOf("isoWeek").add(a.dagVanDeWeek-1,"day");t.innerHTML+=`\n        <tr>\n          <td class="p-2 text-gray-700">${["Maandag","Dinsdag","Woensdag","Donderdag","Vrijdag","Zaterdag","Zondag"][a.dagVanDeWeek-1]}</td>\n          <td class="p-2 text-gray-700">${s.format("DD MMMM YYYY")}</td>\n          <td class="p-2 text-gray-700">${a.dienst}</td>\n          <td class="p-2">\n            <input type="text" value="${comments[n]}" data-key="${n}" ${isEditable?"":"disabled"} class="w-full p-2 border border-gray-300 rounded-lg">\n          </td>\n          <td class="p-2">\n            <input type="text" value="${locoflexComments[n]}" data-locoflex-key="${n}" ${isEditable?"":"disabled"} class="w-full p-2 border border-gray-300 rounded-lg">\n          </td>\n        </tr>\n      `})),document.querySelectorAll("input[data-key]").forEach((e=>{e.addEventListener("input",(e=>{const t=e.target.dataset.key;comments[t]=e.target.value}))})),document.querySelectorAll("input[data-locoflex-key]").forEach((e=>{e.addEventListener("input",(e=>{const t=e.target.dataset.locoflexKey;locoflexComments[t]=e.target.value}))}))}async function saveComments(){const e=document.getElementById("save-button");e.textContent="Opslaan...",e.disabled=!0;try{const e=Object.entries(comments).map((([e,t])=>{const[a,n]=e.split("-");return{...roosters.find((e=>e.startKalenderWeek==a&&e.dagVanDeWeek==n)),opmerkingen:t||"",locoflex:locoflexComments[e]||""}})),t=await fetch("save_comments.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});(await t.json()).success?showFeedback("Gegevens succesvol opgeslagen!","success"):showFeedback("Opslaan mislukt!","error")}catch(e){console.error("Fout bij opslaan van gegevens:",e),showFeedback("Fout bij opslaan van gegevens","error")}finally{e.textContent="Opslaan",e.disabled=!1}}function updateEditableState(){document.querySelectorAll("input").forEach((e=>{e.disabled=!isEditable})),document.getElementById("save-button").disabled=!isEditable}function showFeedback(e,t){const a=document.getElementById("feedback");a.textContent=e,a.className="mt-4 p-4 rounded-lg shadow "+("success"===t?"bg-green-100 text-green-700":"bg-red-100 text-red-700"),a.style.display="block",setTimeout((()=>{a.style.display="none"}),3e3)}function generateOverview(){const e=document.getElementById("week-select").value,t="+-----------+-------------+------------------+",a=[t,"| Dag       | Datum       | Beschikbaarheid  |",t,...roosters.filter((t=>Number(t.startKalenderWeek)===Number(e))).map((t=>{const a=["Maandag","Dinsdag","Woensdag","Donderdag","Vrijdag","Zaterdag","Zondag"][t.dagVanDeWeek-1],n=(new Date).getFullYear();return{day:a,date:dayjs().year(n).isoWeek(e).startOf("isoWeek").add(t.dagVanDeWeek-1,"day").format("DD-MM-YYYY"),availability:locoflexComments[`${t.startKalenderWeek}-${t.dagVanDeWeek}`]||t.locoflex||""}})).map((({day:e,date:t,availability:a})=>`| ${e.padEnd(9)} | ${t.padEnd(11)} | ${a.padEnd(16)} |`)),t].join("\n"),n=new Blob([a],{type:"text/plain"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`Overzicht_Week_${e}.txt`,s.click(),URL.revokeObjectURL(o)}document.addEventListener("DOMContentLoaded",(()=>{fetchAllWeeks(),document.getElementById("edit-toggle").addEventListener("change",(e=>{isEditable="aan"===e.target.value,updateEditableState()})),document.getElementById("save-button").addEventListener("click",saveComments)})),document.addEventListener("DOMContentLoaded",(()=>{fetchAllWeeks(),document.getElementById("edit-toggle").addEventListener("change",(e=>{isEditable="aan"===e.target.value,updateEditableState()})),document.getElementById("save-button").addEventListener("click",saveComments),document.getElementById("generate-overview-button").addEventListener("click",generateOverview)}));